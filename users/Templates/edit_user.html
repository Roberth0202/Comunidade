{% extends 'feed_base.html' %}
{% load static %}

{% block content %}
<div class="edit-user-container">
    <section class="editar-user">
        <h2>ConfiguraÃ§Ã£o de usuario</h2>
        <form class="form-edit-user" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Custom Image Upload Section -->
            <div class="images-upload-container">
                <!-- Capa -->
                <div class="capa-upload-wrapper" onclick="document.getElementById('id_capa').click()">
                    {% if user.capa %}
                        <img src="{{ user.capa.url }}" class="capa-preview" id="capa-preview">
                    {% else %}
                        <img src="" class="capa-preview" id="capa-preview" style="display: none;">
                        <div class="default-capa" style="width: 100%; height: 100%; background-color: #888;"></div>
                    {% endif %}
                    <div class="image-overlay">
                        <span class="camera-icon">ðŸ“·</span>
                    </div>
                </div>

                <!-- Avatar -->
                <div class="avatar-upload-wrapper" onclick="document.getElementById('id_avatar').click()">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" class="avatar-preview" id="avatar-preview">
                    {% else %}
                        <img src="{% static 'img/default-avatar.svg' %}" class="avatar-preview" id="avatar-preview">
                    {% endif %}
                    <div class="image-overlay">
                        <span class="camera-icon">ðŸ“·</span>
                    </div>
                </div>
            </div>

            <!-- Hidden Inputs for Images -->
            <div style="display: none;">
                {{ form.capa }}
                {{ form.avatar }}
            </div>

            <!-- Other Fields -->
            {% for field in form %}
            {% if field.name != 'capa' and field.name != 'avatar' %}
            
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}
                <div class="error-message">
                    {% for error in field.errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
                {% if field.help_text %}
                <small class="form-text text-muted">{{ field.help_text }}</small>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}

            <button type="submit" class="btn btn-primary" style="margin-top: 40px;">Salvar AlteraÃ§Ãµes</button>
        </form>

        <script>
            function handleImagePreview(inputId, previewId) {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);

                input.addEventListener('change', function () {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();

                        reader.onload = function (e) {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                            // Hide default div if it exists (sibling of preview)
                            const sibling = preview.nextElementSibling;
                            if (sibling && sibling.classList.contains('default-capa')) {
                                sibling.style.display = 'none';
                            }
                        }

                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }

            // Initialize previews
            // Note: Django form fields usually have id="id_fieldname"
            document.addEventListener('DOMContentLoaded', function () {
                handleImagePreview('id_capa', 'capa-preview');
                handleImagePreview('id_avatar', 'avatar-preview');
            });
        </script>
    </section>
</div>
{% endblock %}